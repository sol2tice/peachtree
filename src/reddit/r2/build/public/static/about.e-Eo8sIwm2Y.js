window.Modernizr=function(a,b,c){function d(a,b){for(var d in a)if(j[a[d]]!==c)return b=="pfx"?a[d]:!0;return!1}function f(a,b,e){var g=a.charAt(0).toUpperCase()+a.substr(1),f=(a+" "+m.join(g+" ")+g).split(" ");if(typeof b==="string"||typeof b==="undefined")return d(f,b);else{f=(a+" "+i.join(g+" ")+g).split(" ");a:{var a=f,h;for(h in a)if(g=b[a[h]],g!==c){if(e===!1){b=a[h];break a}if(typeof g==="function"){b=g.bind(e||b);break a}b=g;break a}b=!1}return b}}var e={},g=b.documentElement,h=b.createElement("modernizr"),
j=h.style,a=" -webkit- -moz- -o- -ms- ".split(" "),m="Webkit Moz O ms".split(" "),i="webkit moz o ms".split(" "),h={},k=[],l=k.slice,n,q=function(a,c,d,e){var f,h=b.createElement("div"),j=b.body,i=j?j:b.createElement("body");if(parseInt(d,10))for(;d--;)f=b.createElement("div"),f.id=e?e[d]:"modernizr"+(d+1),h.appendChild(f);d=["&#173;<style>",a,"</style>"].join("");h.id="modernizr";(j?h:i).innerHTML+=d;i.appendChild(h);if(!j)i.style.background="",g.appendChild(i);a=c(h,a);!j?i.parentNode.removeChild(i):
h.parentNode.removeChild(h);return!!a},o={}.hasOwnProperty,s;s=typeof o!=="undefined"&&typeof o.call!=="undefined"?function(a,b){return o.call(a,b)}:function(a,b){return b in a&&typeof a.constructor.prototype[b]==="undefined"};if(!Function.prototype.bind)Function.prototype.bind=function(a){var b=this;if(typeof b!="function")throw new TypeError;var c=l.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var e=new e,g=b.apply(e,c.concat(l.call(arguments)));
if(Object(g)===g)return g;return e}else return b.apply(a,c.concat(l.call(arguments)))};return d};(function(a,b){var c=a.join(""),d=b.length;q(c,function(a){for(var a=a.childNodes,b={};d--;)b[a[d].id]=a[d];e.csstransforms3d=(b.csstransforms3d&&b.csstransforms3d.offsetLeft)===9&&b.csstransforms3d.offsetHeight===3},d,b)})([,["@media (",a.join("transform-3d),("),"modernizr){#csstransforms3d{left:9px;position:absolute;height:3px;}}"].join("")],[,"csstransforms3d"]);h.boxshadow=function(){return f("boxShadow")};
h.csstransforms3d=function(){var a=!!f("perspective");a&&"webkitPerspective"in g.style&&(a=e.csstransforms3d);return a};for(var p in h)s(h,p)&&(n=p.toLowerCase(),e[n]=h[p](),k.push((e[n]?"":"no-")+n));j.cssText="";h=null;e._version="2.5.3";e._prefixes=a;e._domPrefixes=i;e._cssomPrefixes=m;e.testProp=function(a){return d([a])};e.testAllProps=f;e.testStyles=q;g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(" js "+k.join(" "));return e}(this,this.document);
(function(a,b){var c=a.parse,d=[1,4,5,6,7,10,11];a.parse=function(f){var e,g=0;if(e=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(f)){for(var f=0,h;h=d[f];++f)e[h]=+e[h]||0;e[2]=(+e[2]||1)-1;e[3]=+e[3]||1;e[8]!=="Z"&&e[9]!==b&&(g=e[10]*60+e[11],e[9]==="+"&&(g=0-g));e=a.UTC(e[1],e[2],e[3],e[4],e[5]+g,e[6],e[7])}else e=c?c(f):NaN;return e}})(Date);
SlideshowView=Backbone.View.extend({events:{"click button.prev":"prev","click button.next":"next",mouseover:"pause",mouseout:"play"},initialize:function(){this.collection.bind("reset",this.render,this);this.index=0;this.$(".image").empty()},_delta:function(a){return(this.collection.length+this.index+a)%this.collection.length},_image:function(a,b){var c=this.collection.at(b),d=this.$(".image .id-"+b);d.length||(d=$("<img>").appendTo(this.$(".image")));d.attr({src:c.get("src"),alt:c.get("title"),"class":a+
" id-"+b})},render:function(){this._image("prev",this._delta(-1));this._image("current",this.index);this._image("next",this._delta(1));this.$(".current-index").text(this.index+1);this.$(".total").text(this.collection.length);return this},prev:function(){this.index=this._delta(-1);this.render()},next:function(){this.index=this._delta(1);this.render()},play:function(){if(!this._interval)this._interval=setInterval(_.bind(this.next,this),this.interval);this.render()},pause:function(){if(this._interval)clearInterval(this._interval),
this._interval=null}});TimelineEvent=Backbone.Model.extend({});TimelineEventCollection=Backbone.Collection.extend({model:TimelineEvent,comparator:function(a){return Number(a.get("date"))}});
TimelineEventView=Backbone.View.extend({initialize:function(){this.model=new TimelineEvent({date:Date.parse(this.$("time").attr("datetime")),"class":this.$el.attr("class"),title:this.$(".title").text()})},render:function(){this.$(".event-content").wrap('<div class="event-marker">');return this},positionDot:function(a){this.$el.css("left",a)},positionLabel:function(a,b,c,d){this.$el.css("z-index",c);this.$(".event-marker").css({height:"+="+a,width:this.$(".event-content").width()+b}).addClass(d);this.$(".event-content").show().css("left",
b).toggleClass("offset",b!=0)},labelWidth:function(){return this.$(".event-content").outerWidth(!0)}});
TimelineView=Backbone.View.extend({rowHeight:30,events:{"mouseover .event":"focusEvent","mouseout .event":"unfocusEvent"},eventViews:{},initialize:function(){this.collection=new TimelineEventCollection;_.each(this.$(".event"),function(a){a=(new TimelineEventView({el:a})).render();this.eventViews[a.model.cid]=a},this);this.collection.reset(_.pluck(this.eventViews,"model"))},fitBounds:function(){this.bounds={};var a=this.bounds.min=new Date(this.collection.first().get("date")),b=this.bounds.max=new Date(this.collection.last().get("date"));
a.setMonth(0);a.setDate(1);b.setMonth(0);b.setDate(1);b.setFullYear(this.bounds.max.getFullYear()+1);this.bounds.range=b-a},position:function(a){return(a-this.bounds.min)/this.bounds.range},filter:function(){return!0},filterTop:function(){return!0},renderAxis:function(){var a=this.$(".axis");a.length||(a=$("<div>").addClass("axis").appendTo(this.$el));a.empty();var b=a.innerWidth(),c=new Date(this.bounds.min);c.setMonth(0);for(c.setDate(1);c<=this.bounds.max;){var d=$("<div>");d.addClass("label year").text(c.getFullYear()).appendTo(a);
d.css("left",(b-d.width())*this.position(c));c.setFullYear(c.getFullYear()+1)}},render:function(){this.$el.addClass("timeline");this.fitBounds();this.renderAxis();for(var a=this.collection.toArray(),b=this.$el.width(),c={top:0,bottom:0},d={top:[[]],bottom:[[]]},f=a.length;a.length&&f>0;){var e=_.clone(c),a=_.reject(a,function(a){var e=this.eventViews[a.cid],f=this.filterTop(a)?"top":"bottom",m=this.position(a.get("date")),i=Math.round(m*b),k=e.labelWidth(),l=Math.min(0,b-(i+k));i+=l;e.positionDot(100*
m+"%");if(this.filter(a)){if(i>=c[f]&&i+k<=b)return d[f][0].push({view:e,offset:l}),c[f]=i+k,!0}else return d[f][0].push({view:e,offset:l}),!0},this);_.each(c,function(a,b){a>0&&a==e[b]&&(c[b]=0,d[b].unshift([]))});f--}_.each(d,function(a,b){_.each(_.reject(a,_.isEmpty),function(c,d){_.each(c,function(c){c.view.positionLabel(this.rowHeight*d,c.offset,a.length-d,b)},this)},this)},this);this.$el.css({"margin-top":this.rowHeight*d.top.length,"margin-bottom":this.rowHeight*d.bottom.length});return this},
focusEvent:function(){this.$el.addClass("focusing")},unfocusEvent:function(){this.$el.removeClass("focusing")}});
GridView=Backbone.View.extend({initialize:function(){this.collection.on("add",this.addOne,this).on("reset",this.addAll,this).on("all",_.debounce(this.render),this);this.itemViews={};this.addAll()},createItemView:function(a){return new Backbone.View({model:a})},addOne:function(a){if(!this.itemViews[a.id]){var b=this.createItemView(a);this.itemViews[a.id]=b}},addAll:function(){this.collection.each(this.addOne,this)},render:function(){var a=this.$el.width(),b=0,c=0,d={x:0,y:0},f=this.collection.state&&
this.collection.state.get("sort");this.collection.each(function(e){var g=this.itemViews[e.id],h=g.$el.outerWidth(!0),j=g.$el.outerHeight(!0);if(d.x+h>a)d.x=0,d.y+=c;c=j;b=d.y+j;g.$el.css({position:"absolute",left:d.x,top:d.y});f&&g.$el.toggleClass("novalue",!e.has(f));d.x+=h},this);this.$el.css("height",b).removeClass("loading");return this}});r.about={pages:{}};_.extend(_.templateSettings,{variable:"d"});
$(function(){var b;var a=$(".content.about-page");a&&(b=a=r.about.pages[a.attr("id")],a=b)&&a()});
AboutSlideshowView=SlideshowView.extend({interval:1E4,render:function(){SlideshowView.prototype.render.apply(this);var a=this.collection.at(this.index);this.$(".title").attr("href",a.get("url")).text(a.get("title"));this.$(".author").attr("href",a.get("author_url")).text(a.get("author"));this.$(".user").attr("href",a.get("via_url")).text(a.get("via"));this.$(".comments").attr("class",a.get("comment_class")).attr("href",a.get("permalink")).addClass("comments").text(a.get("comment_label"));return this}});
AboutTimelineView=TimelineView.extend({rowHeight:30,filter:function(a){return~a.get("class").indexOf("important")},filterTop:function(a){return~a.get("class").indexOf("org")}});r.about.pages["about-main"]=function(){slideshowImages=new Backbone.Collection;slideshowImages.fetch({url:"#images"});(new AboutSlideshowView({el:$("#slideshow"),collection:slideshowImages})).play();(new AboutTimelineView({el:$("#history .events")})).render()};
TeamRouter=Backbone.Router.extend({routes:{"":"sort","sort/:sortId":"sort","sort/:sortId/user/:username":"sort","user/:username":"username"},defaultSortId:"random",initialize:function(a){this.sortState=a.sortState;this.popup=a.popup;this.grids=a.grids;a.popup.on("show hide",this.updateState,this)},updateState:function(){var a=[],b=this.sortState.get("sort"),c=this.popup.model&&this.popup.model.id;b&&!(c&&b==this.defaultSortId)&&a.push("sort/"+b);c&&a.push("user/"+c);this.navigate(a.join("/"),{replace:!0})},
sort:function(a,b){if(!a&&!this.sortState.has("sort"))a=this.defaultSortId;a&&this.sortState.set("sort",a);b&&this.username(b)},username:function(a){this.sort();_.defer(_.bind(function(){_.find(this.grids,function(b){b.showPopup(a,!0)})},this))}});
DropdownView=Backbone.View.extend({events:{"click .choice":"select"},initialize:function(a){this.attribute=a.attribute;this.model.on("change:"+this.attribute,this.render,this)},render:function(){var a=this.$(".drop-choices .choice-"+this.model.get(this.attribute));this.$(".drop-choices .selected").removeClass("selected");a.addClass("selected").removeClass("hidden-sort");this.$(".dropdown .selected").text(a.text());return this},select:function(a){a=$(a.target).attr("class").match(/choice-(.*)/)[1];
this.model.set(this.attribute,a);this.trigger("select",a)}});TeamMember=Backbone.Model.extend({idAttribute:"username",initialize:function(){this.set("random",Math.random())}});
SortableCollection=Backbone.Collection.extend({model:TeamMember,initialize:function(a,b){this.sorts=b.sorts;this.state=b.state||new Backbone.Model({sort:null});this.state.on("change:sort",this.sort,this)},comparator:function(a){var b=this.sorts.get(this.state.get("sort"));if(b){var c=a.get(b.id);_.isNumber(c)?c*=b.get("dir"):_.isString(c)&&(c=c.toLowerCase());return c||a.get("random")}}});
PersonDetailsPopup=Backbone.View.extend({id:"person-overlay",events:{"click .close":"hide"},template:_.template('<button class="close">x</button><div class="top"><strong class="name"><%- d.name %></strong><em class="role" title="<%- d.role_details %>"><%- d.role %></em></div><div class="description"><p><%- d.description %></p><div class="favorite-subreddits"><span>favorite subreddits:</span><ul></ul></div></div><div class="etc"><a href="http://www.reddit.com/user/<%- d.username %>" target="_blank">reddit.com/user/<%- d.username %></a></div>'),initialize:function(){$("body").click(_.bind(function(a){this.targetView&&
($(a.target).closest($([this.el,this.targetView.el])).length||this.hide())},this));$(window).resize(_.bind(this.position,this))},render:function(){this.$el.empty().append(this.template(this.model.toJSON()));var a=this.$(".favorite-subreddits ul");_.each(this.model.get("favorite_subreddits"),function(b){$("<li>").append($("<a>").attr("href",b).text(b)).appendTo(a)})},position:function(){if(this.targetView){var a=this.targetView.$(".avatar"),b=a.offset(),c=this.$el.parent(),c=b.left<c.offset().left+
c.width()/2;this.$el.css({top:b.top,left:b.left+(c?a.outerWidth(!0):-this.$el.width())}).removeClass("left right").addClass(c?"left":"right")}},show:function(a){var b=this.model;this.targetView&&this.targetView.$el.removeClass("focused");this.targetView=a;this.model=a.model;this.render();this.position();this.$el.show();this.targetView.$el.addClass("focused");this.trigger("show",this.model,b)},hide:function(){var a=this.model;this.model=null;if(this.targetView)this.targetView.$el.removeClass("focused"),
this.targetView=null,this.trigger("hide",a);this.$el.hide()},toggle:function(a){a==this.targetView?this.hide():this.show(a)}});PersonView=Backbone.View.extend({events:{click:"showInfo"},showInfo:function(){this.options.popup.toggle(this)}});
PeopleGridView=GridView.extend({initialize:function(){GridView.prototype.initialize.apply(this);this.collection.on("reset",this.options.popup.hide,this.options.popup);this.options.popup.on("show",this.focus,this).on("hide",this.unfocus,this)},createItemView:function(a){return new PersonView({el:this.$("."+a.id),model:a,popup:this.options.popup})},showPopup:function(a,b){var c=this.itemViews[a];if(!c)return!1;this.options.popup.show(c);if(b){var d=c.$el.offset().top+c.$el.height();$(window).scrollTop(Math.max(0,
d-$(window).height()/2))}return c},focus:function(a,b){var c=$(".content");this.$el.addClass("focusing");b&&c.removeClass("focusing-"+b.id);c.addClass("focusing-"+a.id)},unfocus:function(a){this.$el.removeClass("focusing");$(".content").removeClass("focusing-"+a.id)}});
r.about.pages["about-team"]=function(){var a=new Backbone.Collection,b=new SortableCollection(null,{sorts:a}),c=new SortableCollection(null,{sorts:a,state:b.state});a.fetch({url:"#sorts"});b.fetch({url:"#team"});c.fetch({url:"#alumni"});new DropdownView({el:$("#about-team .sort-menu"),model:b.state,attribute:"sort"});new r.ui.scrollFixed($("#about-team .sort-menu"));a=new PersonDetailsPopup;$("#about-team").append(a.el);var d=new PeopleGridView({el:$("#team-grid"),collection:b,popup:a}),c=new PeopleGridView({el:$("#alumni-grid"),
collection:c,popup:a});new TeamRouter({sortState:b.state,popup:a,grids:[d,c]});Backbone.history.start()};var baseURL="http://postcards.redditstatic.com/",mapURL=_.template("http://maps.google.com/?q=<%= d.lat %>,<%= d.long %>"),mapImageURL=_.template("//maps.googleapis.com/maps/api/staticmap?zoom=<%= d.zoom %>&size=<%= d.width %>x<%= d.height %>&sensor=false&markers=size:mid%7Ccolor:red%7C<%= d.lat %>,<%= d.long %>"),redditButtonURL=_.template(r.utils.staticURL("button/button2.html?sr=postcards&url=<%= d.url %>"));
Postcard=Backbone.Model.extend({});PostcardsPlaceholder=Backbone.Model.extend({});
PostcardCollection=Backbone.Collection.extend({model:Postcard,url:r.utils.s3HTTPS(baseURL+"postcards-latest.js"),chunkSize:null,loadedChunks:{},ensureLoaded:function(a,b){this.get(a)&&b&&b();for(var c,d=0;d<this.chunkCount;d++){var f=this.chunkIndex[d];if(a>=f[0]&&a<=f[1]){c=d;break}}c!=null&&(c in this.loadedChunks?b&&b():this.fetchChunk({chunk:c,success:b}))},fetchInitial:function(a){var b=a.success;a.reset=!0;a.success=_.bind(function(a,d){this.chunkSize=d.postcards.length;this.totalCount=d.total_postcard_count;
this.chunkIndex=d.index;this.chunkCount=_.size(this.chunkIndex);var f=a.min(function(a){return a.id}).id;_.each(this.chunkIndex,function(a,b){a[1]=Math.min(f,a[1]);a[1]>a[0]&&this.add(new PostcardsPlaceholder({chunkStart:a[0],chunkEnd:a[1],id:"chunk"+b}))},this);this.trigger("load",this,this.options);b&&b(a,d)},this);this.fetch(a)},fetchChunk:function(a){a.url=r.utils.s3HTTPS(baseURL+"postcards"+a.chunk+".js");a.remove=!1;a.merge=!1;var b=a.success;a.success=_.bind(function(a,d){var f=this.get("chunk"+
d.chunk_id),e=_.chain(d.postcards).map(function(a){return this.get(a.id)},this).sortBy(this.comparator).value();this.loadedChunks[d.chunk_id]=!0;this.remove(f);this.trigger("replace",f,e,this,this.options);b&&b(this,d)},this);this.fetch(a)},sync:function(a,b,c){Backbone.sync(a,b,_.extend({dataType:"jsonp",jsonp:!1,jsonpCallback:"postcardCallback"+("chunk"in c?c.chunk:""),cache:c.chunk!=null},c))},parse:function(a){return a.postcards},comparator:function(a){return a instanceof Postcard?-a.id:-a.get("chunkStart")}});
PostcardRouter=Backbone.Router.extend({routes:{"view/:cardId":"viewCard","view/:cardId/:side":"viewCard"},initialize:function(a){this.zoomer=a.zoomer;this.zoomer.on("showcard",function(a,c){this.navigate("view/"+a+"/"+c,{replace:!0})},this);this.zoomer.on("hidecard",function(){this.navigate("/",{replace:!0})},this)},viewCard:function(a,b){this.zoomer.zoomById(Number(a),b)}});
var PostcardOverlayView=Backbone.View.extend({tagName:"div",distanceThreshold:10,initialize:function(){this.options.parent.bind("showcard",this._position,this);this.options.parent.bind("hidecard",this.hide,this);this.currentTarget={left:0,top:0};this.$el.addClass("postcard-overlay")},hide:function(){this.$el.addClass("hide")},_position:function(){var a=this.currentTarget,b=this._target();if(Math.sqrt(Math.pow(b.left-a.left,2)+Math.pow(b.top-a.top,2))>=this.distanceThreshold)this.hide(),this.$el.css(b),
this.currentTarget=b,_.delay(_.bind(function(){$(this.el).removeClass("hide").addClass("show")},this),Modernizr.csstransforms3d?500:0)}}),PostcardInfoView=PostcardOverlayView.extend({className:"infobox",template:_.template('<a class="maplink" target="_blank"><img class="map"></a><span class="date"></span>'),events:{mouseover:"zoomIn",mouseout:"zoomOut"},render:function(){this.$el.append(this.template());this.zoomOut();this.$(".date").text(this.model.get("date"));return this},zoomIn:function(){this.updateMap(8)},
zoomOut:function(){this.updateMap(1)},updateMap:function(a){this.$(".maplink").attr("href",mapURL({lat:this.model.get("latitude"),"long":this.model.get("longitude")}));this.$(".map").attr("src",mapImageURL({lat:this.model.get("latitude"),"long":this.model.get("longitude"),width:85,height:85,zoom:a})).width(85).height(85)},_target:function(){var a=this.options.parent.currentFacePosition();return{left:a.left-this.$el.outerWidth()-10,top:a.top}}}),PostcardRedditView=PostcardOverlayView.extend({className:"redditbutton",
render:function(){var a=String(window.location).replace("#","").replace(/\/(front|back)$/,""),b=$('<iframe src="'+redditButtonURL({url:encodeURIComponent(a)})+'">');b.css("opacity",0).load(function(){b.css("opacity",1)});this.$el.append(b);return this},_target:function(){var a=PostcardInfoView.prototype._target.apply(this);a.top+=115;return a}}),PostcardCloseView=PostcardOverlayView.extend({className:"postcard-close",distanceThreshold:0,events:{click:"unzoom"},unzoom:function(){this.options.zoomer.unzoom()},
_target:function(){var a=this.options.parent.currentFacePosition();return{left:a.right,top:a.top}}}),PostcardZoomView=Backbone.View.extend({tagName:"div",className:"postcard-zoombox",topSpace:20,template:_.template('<div class="zoom"><img class="face front"><img class="face back"></div>'),events:{"click .zoom .face":"flip"},initialize:function(){this.model=this.model||this.options.parent.model;this.$el.append(this.template());this.$el.append((new PostcardInfoView({model:this.model,parent:this})).render().el);
this.$el.append((new PostcardRedditView({parent:this})).render().el);this.$el.append((new PostcardCloseView({parent:this,zoomer:this.options.zoomer})).render().el);var a=this.model.get("images").small;a.front.width>a.front.height!=a.back.width>a.back.height&&$(this.el).addClass("rotate");this.currentSide="front"},render:function(){this._changeSize("small");this._scale();this._origPosition();return this},currentImages:function(){return this.model.get("images")[this.size]},currentImage:function(){return this.currentImages()[this.currentSide]},
currentFacePosition:function(){var a=this.currentImage(),b={left:this.position.left+(this.maxWidth-a.width)/2,top:this.position.top+(this.maxHeight-a.height)/2};b.right=b.left+a.width;b.bottom=b.top+a.height;return b},_origPosition:function(){var a=this.options.parent.$("img").offset();this.$(".zoom").css({left:a.left-this.frontLeft,top:a.top-this.frontTop})},_changeSize:function(a){this.size=a;a=this.currentImages();this.maxWidth=Math.max(a.front.width,a.back.width);this.maxHeight=Math.max(a.front.height,
a.back.height);this.frontLeft=(this.maxWidth-a.front.width)/2;this.frontTop=(this.maxHeight-a.front.height)/2},_scale:function(a,b){var c=this.currentImages();this.$(".zoom").css({width:c.front.width,height:c.front.height,marginLeft:this.frontLeft,marginTop:this.frontTop});this.$(".front").attr("width",c.front.width).attr("height",c.front.height);this.$(".back").attr("width",c.back.width).attr("height",c.back.height).css({left:(c.front.width-c.back.width)/2,top:(c.front.height-c.back.height)/2});
b||(this.$(".front").attr("src",r.utils.s3HTTPS(baseURL+c.front.filename)),this.$(".back").attr("src",r.utils.s3HTTPS(baseURL+c.back.filename)))},flip:function(){if(this.$el.is(".zoomed"))return this.$el.toggleClass("flipped"),this.currentSide=this.$el.is(".flipped")?"back":"front",this.trigger("flip",this.currentSide),this.trigger("showcard"),this},zoom:function(){this._changeSize("full");this.position={left:($(window).width()-this.maxWidth)/2,top:Math.max(this.$el.parent().position().top+this.topSpace,
$(window).scrollTop()+($(window).height()-this.maxHeight)/2)};this.$(".zoom").css(this.position);this._scale();this.$el.addClass("zoomed");this.trigger("showcard");return this},unzoom:function(){this.trigger("hidecard");this._changeSize("small");this._origPosition();this._scale(!0);this.$el.removeClass("flipped zoomed");_.delay(_.bind(function(){this.unbind();this.remove()},this),Modernizr.csstransforms3d?700:0)}}),PostcardView=Backbone.View.extend({tagName:"div",className:"postcard",events:{"click img":"zoom"},
render:function(){var a=this.model.get("images").small.front||{};this.$el.append($("<img>").attr({src:r.utils.s3HTTPS(baseURL+a.filename),width:a.width,height:a.height}).css("margin-top",-a.height/2)).addClass("postcard-"+this.model.id);return this},zoom:function(){this.options.zoomer.zoom(this,"back")}}),PostcardsPlaceholderView=Backbone.View.extend({tagName:"div",className:"placeholder",perLine:4,lineHeight:223,render:function(){this.$el.css("height",Math.ceil(this.options.parent.collection.chunkSize/
this.perLine)*this.lineHeight).addClass("placeholder-"+this.model.id);return this}}),PostcardGridView=Backbone.View.extend({initialize:function(){this.collection.on("replace",this.replace,this).on("load",this.addAll,this);this.itemViews=[];this.placeholders=[];_.bindAll(this,"_clickOut","_scroll");$("body").bind("click",this._clickOut);$(window).bind("scroll",this._scroll)},replace:function(a,b){var c=document.createDocumentFragment();_.each(b,function(a){if(a instanceof Postcard)var b=new PostcardView({model:a,
zoomer:this});else a instanceof PostcardsPlaceholder&&(b=new PostcardsPlaceholderView({model:a,parent:this}),this.placeholders.push(b));c.appendChild(b.render().el);this.itemViews[a.id]=b},this);a&&a.id in this.itemViews?(this.itemViews[a.id].$el.replaceWith(c),delete this.itemViews[a.id]):this.$el.append(c)},addAll:function(){this.replace(null,this.collection.models)},zoomById:function(a,b){this.collection.ensureLoaded(a,_.bind(function(){var c=this.itemViews[a];c&&($(window).scrollTop(c.$el.offset().top-
$(window).height()/2),this._scroll(),this.zoom(c,b))},this))},zoom:function(a,b){b=b||"front";if(!this.currentZoom||a.model.id!=this.currentZoom.model.id){this.unzoom(!0);this.zoomScroll=$(window).scrollTop();this.$el.addClass("zoomed");this.trigger("showcard",a.model.id,b);var c=this.currentZoom=new PostcardZoomView({parent:a,zoomer:this});c.on("flip",this.onFlip,this);$("#about-postcards").append(c.render().el);_.defer(_.bind(function(){c.zoom();b=="back"&&c.flip()},this))}else this.currentZoom.currentSide!=
b&&this.currentZoom.flip()},unzoom:function(a){a||(this.$el.removeClass("zoomed"),this.trigger("hidecard"));if(this.currentZoom)this.currentZoom.unzoom(),this.currentZoom.off("flip",this.onFlip,this),this.currentZoom=null},onFlip:function(a){this.trigger("showcard",this.currentZoom.model.id,a)},_clickOut:function(a){this.currentZoom&&!$(a.target).closest($([this.currentZoom.el,this.currentZoom.options.parent.el])).length&&this.unzoom()},_scroll:_.throttle(function(){var a=$(window).scrollTop();this.currentZoom&&
Math.abs(this.zoomScroll-a)>800&&this.unzoom();this.placeholders=_.reject(this.placeholders,function(b){var c=b.$el.offset(),d=b.$el.height();if(Math.abs(a-c.top)<d+$(window).height())return this.collection.ensureLoaded(b.model.get("chunkStart")),!0},this)},250)});
r.about.pages["about-postcards"]=function(){$(".abouttitle h1").hide();postcards=new PostcardCollection;var a=new PostcardGridView({el:$("#postcards"),collection:postcards});new PostcardRouter({zoomer:a});postcards.fetchInitial({success:function(){Backbone.history.start({pushState:!0,root:"/about/postcards/"});$(".abouttitle h1").find(".count").text(postcards.totalCount).end().fadeIn(100)}})};
